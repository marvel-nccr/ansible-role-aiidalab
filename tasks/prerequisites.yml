---
# Note: AiiDA lab has dropped python2 support for aiida 1.0
- name: Install python3 pip
  become: true
  become_user: "{{ root_user }}"
  apt:
    name: "python3-pip"

- name: install virtualenv
  become: true
  become_user: "{{ root_user }}"
  pip:
    name: virtualenv
    executable: pip3

- name: "Let virtualenvwrapper use the correct python version"
  lineinfile:
    path: "${HOME}/.bashrc"
    regex: "export VIRTUALENVWRAPPER_PYTHON=.*"
    line: "export VIRTUALENVWRAPPER_PYTHON={{ ansible_python_interpreter }}"
  when: ansible_python_interpreter is defined

- name: Install aiidalab python package
  pip:
    name: aiidalab
    version: "{{ aiidalab_version }}"
    virtualenv: "{{ aiidalab_venv }}"
    # extra_args: --no-use-pep517

- name: activate ipython kernel
  shell: "{{ aiidalab_venv }}/bin/python -m ipykernel install --user"
  args:
    creates: "${HOME}/.local/share/jupyter/kernels/python3/kernel.json"

- name: install jupyter extensions
  shell: "{{ aiidalab_venv }}/bin/jupyter nbextension install --sys-prefix --py {{ item }}"
  args:
    creates: "{{ aiidalab_venv }}/share/jupyter/nbextensions/{{ item }}/extension.js"
  with_items:
    - fileupload
